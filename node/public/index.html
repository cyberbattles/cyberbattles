<!doctype html>
<html>
  <head>
    <title>Docker Terminal Control</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <style>
      body {
        font-family: sans-serif;
        background-color: #1e1e1e;
        color: #f0f0f0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .container {
        max-width: 1200px;
        width: 100%;
      }
      fieldset {
        border: 1px solid #555;
        border-radius: 5px;
        margin-bottom: 20px;
        padding: 15px;
      }
      legend {
        color: #00aaff;
        font-weight: bold;
        padding: 0 10px;
      }
      .controls {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }
      input[type='text'],
      input[type='number'] {
        background-color: #333;
        color: #f0f0f0;
        border: 1px solid #555;
        padding: 8px;
        border-radius: 3px;
      }
      button {
        background-color: #0077cc;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 3px;
        cursor: pointer;
      }
      button:hover {
        background-color: #005fa3;
      }
      #terminal-container {
        padding: 10px;
      }
      #terminal {
        border: 1px solid #555;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Docker Web Terminal Control Panel</h1>

      <fieldset>
        <legend>Session Management</legend>
        <div class="controls">
          <label for="admin-jwt">Admin JWT:</label>
          <input
            type="text"
            id="admin-jwt"
            name="admin-jwt"
            placeholder="Paste Admin JWT for session actions"
            size="60"
          />
        </div>
        <hr style="border-color: #444; margin: 15px 0" />
        <div class="controls">
          <label for="scenario-index">Scenario:</label>
          <input
            type="number"
            id="scenario-index"
            name="scenario-index"
            value="0"
            min="0"
          />
          <label for="num-teams">Num Teams:</label>
          <input
            type="number"
            id="num-teams"
            name="num-teams"
            value="2"
            min="1"
          />
          <label for="num-members">Members/Team:</label>
          <input
            type="number"
            id="num-members"
            name="num-members"
            value="1"
            min="1"
          />
          <button id="create-session-btn">Create Session</button>
        </div>
        <div class="controls">
          <label for="session-id">Session ID:</label>
          <input
            type="text"
            id="session-id"
            name="session-id"
            placeholder="Enter Session ID to Start"
          />
          <button id="start-session-btn">Start Session</button>
        </div>
      </fieldset>

      <fieldset>
        <legend>Terminal Connection</legend>
        <div class="controls">
          <label for="teamId">Team ID:</label>
          <input
            type="text"
            id="teamId"
            name="teamId"
            placeholder="Enter Team ID"
          />
          <label for="userId">User ID:</label>
          <input
            type="text"
            id="userId"
            name="userId"
            placeholder="Enter User ID"
          />
          <label for="jwt-token">JWT:</label>
          <input
            type="text"
            id="jwt-token"
            name="jwt-token"
            placeholder="Paste your user JWT here"
            size="60"
          />
          <button id="connect-btn">Connect to Terminal</button>
        </div>
      </fieldset>

      <div id="terminal-container">
        <div id="terminal"></div>
      </div>
    </div>

    <script>
      const term = new Terminal({
        cursorBlink: true,
        rows: 30,
        cols: 120,
        theme: {
          background: '#1e1e1e',
          foreground: '#f0f0f0',
        },
      });
      term.open(document.getElementById('terminal'));
      term.write('Welcome! Use the controls above to manage sessions.\r\n');

      let ws; // To hold the WebSocket instance

      /**
       * A helper function to send POST requests to the server API.
       * @param {string} url The API endpoint.
       * @param {object} data The JSON data to send.
       */
      async function postData(url = '', data = {}) {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });
        return {
          ok: response.ok,
          status: response.status,
          data: response.ok ? await response.json().catch(() => ({})) : null,
        };
      }

      // --- Event Listener for Creating a Session ---
      document
        .getElementById('create-session-btn')
        .addEventListener('click', async () => {
          term.write('\r\nAttempting to create a new session...\r\n');
          const token = document.getElementById('admin-jwt').value;
          if (!token) {
            term.write(
              '\r\nERROR: Admin JWT is required to create a session.\r\n',
            );
            return;
          }

          const selectedScenario = parseInt(
            document.getElementById('scenario-index').value,
          );
          const numTeams = parseInt(document.getElementById('num-teams').value);
          const numMembersPerTeam = parseInt(
            document.getElementById('num-members').value,
          );

          const response = await postData('/api/session', {
            selectedScenario,
            numTeams,
            numMembersPerTeam,
            token,
          });

          if (response.ok) {
            term.write(
              `SUCCESS: Session creation process started (Status: ${response.status}).\r\n`,
            );
            term.write('Check your server logs for the new session ID.\r\n');
          } else {
            term.write(
              `ERROR: Failed to create session (Status: ${response.status}).\r\n`,
            );
          }
        });

      // --- Event Listener for Starting a Session ---
      document
        .getElementById('start-session-btn')
        .addEventListener('click', async () => {
          const sessionId = document.getElementById('session-id').value;
          const token = document.getElementById('admin-jwt').value;
          if (!sessionId) {
            term.write('\r\nERROR: Please enter a Session ID.\r\n');
            return;
          }
          if (!token) {
            term.write(
              '\r\nERROR: Admin JWT is required to start a session.\r\n',
            );
            return;
          }

          term.write(`\r\nAttempting to start session: ${sessionId}...\r\n`);
          const response = await postData('/api/start-session', {
            sessionId,
            token,
          });

          if (response.ok) {
            term.write(
              `SUCCESS: Session start process initiated (Status: ${response.status}).\r\n`,
            );
          } else {
            term.write(
              `ERROR: Failed to start session (Status: ${response.status}).\r\n`,
            );
          }
        });

      // --- Event Listener for WebSocket Terminal Connection ---
      document.getElementById('connect-btn').addEventListener('click', () => {
        if (ws && ws.readyState !== WebSocket.CLOSED) {
          ws.close();
        }
        term.reset();

        const teamId = document.getElementById('teamId').value;
        const userId = document.getElementById('userId').value;
        const token = document.getElementById('jwt-token').value;

        if (!teamId || !userId || !token) {
          term.write('Please enter a Team ID, a User ID, and a JWT token.\r\n');
          return;
        }

        const socketUrl = `ws://${window.location.host}/terminals/${teamId}/${userId}/${token}`;
        term.write(`Connecting to ${socketUrl}...\r\n`);

        ws = new WebSocket(socketUrl);

        ws.onopen = () => {
          term.write('Connection established! You have a shell.\r\n');
          term.focus();
        };

        ws.onmessage = async event => {
          // The data from a WebSocket is often a Blob, which needs to be read
          const data =
            event.data instanceof Blob
              ? new Uint8Array(await event.data.arrayBuffer())
              : event.data;
          term.write(data);
        };

        ws.onclose = event => {
          term.write(`\r\nConnection closed. Code: ${event.code}\r\n`);
        };

        ws.onerror = error => {
          term.write('\r\nAn error occurred with the WebSocket.\r\n');
          console.error('WebSocket Error:', error);
        };
      });

      // --- Set up the single data listener for the terminal ---
      term.onData(data => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(data);
        }
      });
    </script>
  </body>
</html>
