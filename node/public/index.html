<!doctype html>
<html>
  <head>
    <title>Docker Terminal Control</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <style>
      body {
        font-family: sans-serif;
        background-color: #1e1e1e;
        color: #f0f0f0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .container {
        max-width: 1200px;
        width: 100%;
      }
      fieldset {
        border: 1px solid #555;
        border-radius: 5px;
        margin-bottom: 20px;
        padding: 15px;
      }
      legend {
        color: #00aaff;
        font-weight: bold;
        padding: 0 10px;
      }
      .controls {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }
      input[type='text'],
      input[type='number'],
      select {
        background-color: #333;
        color: #f0f0f0;
        border: 1px solid #555;
        padding: 8px;
        border-radius: 3px;
      }
      button {
        background-color: #0077cc;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 3px;
        cursor: pointer;
      }
      button:hover {
        background-color: #005fa3;
      }
      #terminal-container {
        padding: 10px;
      }
      #terminal {
        border: 1px solid #555;
      }
      #session-info {
        margin-top: 15px;
        padding: 10px;
        background-color: #2a2a2a;
        border-radius: 4px;
        border: 1px solid #444;
      }
      #session-info h3 {
        margin-top: 0;
        color: #00aaff;
      }
      #session-info ul {
        list-style-type: none;
        padding-left: 0;
        margin: 0;
      }
      #session-info li {
        background-color: #333;
        padding: 5px 8px;
        border-radius: 3px;
        margin-bottom: 5px;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Docker Web Terminal Control Panel</h1>

      <fieldset>
        <legend>Session Management</legend>
        <div class="controls">
          <label for="admin-jwt">Admin JWT:</label>
          <input
            type="text"
            id="admin-jwt"
            name="admin-jwt"
            placeholder="Paste Admin JWT for session actions"
            size="60"
          />
        </div>
        <hr style="border-color: #444; margin: 15px 0" />
        <div class="controls">
          <label for="scenario-index">Scenario:</label>
          <select id="scenario-index" name="scenario-index">
            <option value="0">0: ubuntu:latest</option>
          </select>
          <label for="num-teams">Num Teams:</label>
          <input
            type="number"
            id="num-teams"
            name="num-teams"
            value="2"
            min="1"
          />
          <label for="num-members">Members/Team:</label>
          <input
            type="number"
            id="num-members"
            name="num-members"
            value="1"
            min="1"
          />
          <button id="create-session-btn">Create Session</button>
        </div>
        <div class="controls">
          <label for="session-id">Session ID:</label>
          <input
            type="text"
            id="session-id"
            name="session-id"
            placeholder="Autofilled after creation"
            readonly
          />
          <button id="start-session-btn">Start Session</button>
        </div>
        <div id="session-info" style="display: none">
          <h3>Created Team IDs</h3>
          <ul id="team-id-list"></ul>
        </div>
      </fieldset>

      <fieldset>
        <legend>Terminal Connection</legend>
        <div class="controls">
          <label for="teamId">Team ID:</label>
          <select id="teamId" name="teamId">
            <option>-- Start a session first --</option>
          </select>
          <label for="userId">User ID:</label>
          <select id="userId" name="userId">
            <option>-- Select a team first --</option>
          </select>
          <label for="jwt-token">JWT:</label>
          <input
            type="text"
            id="jwt-token"
            name="jwt-token"
            placeholder="Autofills from Admin JWT"
            size="60"
          />
          <button id="connect-btn">Connect to Terminal</button>
        </div>
      </fieldset>

      <div id="terminal-container">
        <div id="terminal"></div>
      </div>
    </div>

    <script>
      const term = new Terminal({
        cursorBlink: true,
        rows: 30,
        cols: 120,
        theme: {
          background: '#1e1e1e',
          foreground: '#f0f0f0',
        },
      });
      term.open(document.getElementById('terminal'));
      term.write('Welcome! Use the controls above to manage sessions.\r\n');

      let ws; // To hold the WebSocket instance
      let sessionTeams = []; // To hold details for populating dropdowns
      let createdTeamIds = []; // To hold IDs from session creation

      /**
       * A helper function to send POST requests to the server API.
       * @param {string} url The API endpoint.
       * @param {object} data The JSON data to send.
       */
      async function postData(url = '', data = {}) {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });
        const responseData = await response.json().catch(() => ({}));
        return {
          ok: response.ok,
          status: response.status,
          data: responseData,
        };
      }

      // --- Event Listener for JWT Autofill ---
      document.getElementById('admin-jwt').addEventListener('input', event => {
        document.getElementById('jwt-token').value = event.target.value;
      });

      // --- Event Listener for Creating a Session ---
      document
        .getElementById('create-session-btn')
        .addEventListener('click', async () => {
          term.write('\r\nAttempting to create a new session...\r\n');
          const token = document.getElementById('admin-jwt').value;
          if (!token) {
            term.write(
              '\r\nERROR: Admin JWT is required to create a session.\r\n',
            );
            return;
          }

          const selectedScenario = parseInt(
            document.getElementById('scenario-index').value,
          );
          const numTeams = parseInt(document.getElementById('num-teams').value);
          const numMembersPerTeam = parseInt(
            document.getElementById('num-members').value,
          );

          const response = await postData('/api/session', {
            selectedScenario,
            numTeams,
            numMembersPerTeam,
            token,
          });

          if (response.ok && response.data.result) {
            const {sessionId, teamIds} = response.data.result;
            term.write(
              `SUCCESS: Session ${sessionId} created with ${teamIds.length} teams.\r\n`,
            );

            // Autofill session ID and store team IDs
            document.getElementById('session-id').value = sessionId;
            createdTeamIds = teamIds;

            // Display team IDs elegantly
            const teamList = document.getElementById('team-id-list');
            const sessionInfoDiv = document.getElementById('session-info');
            teamList.innerHTML = ''; // Clear previous list
            teamIds.forEach(id => {
              const listItem = document.createElement('li');
              listItem.textContent = id;
              teamList.appendChild(listItem);
            });
            sessionInfoDiv.style.display = 'block';
          } else {
            const errorMsg =
              response.data.result || `Status: ${response.status}`;
            term.write(
              `\r\nERROR: Failed to create session. Server says: ${errorMsg}\r\n`,
            );
          }
        });

      // --- Event Listener for Starting a Session ---
      document
        .getElementById('start-session-btn')
        .addEventListener('click', async () => {
          const sessionId = document.getElementById('session-id').value;
          const token = document.getElementById('admin-jwt').value;
          if (!sessionId) {
            term.write('\r\nERROR: No Session ID found to start.\r\n');
            return;
          }
          if (!token) {
            term.write(
              '\r\nERROR: Admin JWT is required to start a session.\r\n',
            );
            return;
          }

          term.write(`\r\nAttempting to start session: ${sessionId}...\r\n`);
          const response = await postData('/api/start-session', {
            sessionId,
            token,
          });

          if (response.ok) {
            term.write(
              `SUCCESS: ${response.data.result} (Status: ${response.status}).\r\n`,
            );
            // Process the teams and members to populate dropdowns
            populateConnectionDropdowns(response.data.teamsAndMembers);
          } else {
            const errorMsg =
              response.data.result || `Status: ${response.status}`;
            term.write(
              `\r\nERROR: Failed to start session. Server says: ${errorMsg}\r\n`,
            );
          }
        });

      /**
       * Populates the Team and User dropdowns based on the server response.
       * @param {object} teamsAndMembers - The object mapping team names to user IDs.
       */
      function populateConnectionDropdowns(teamsAndMembers) {
        if (!teamsAndMembers || createdTeamIds.length === 0) {
          term.write(
            '\r\nWARN: No team data received or session not created properly.\r\n',
          );
          return;
        }

        const teamSelect = document.getElementById('teamId');
        teamSelect.innerHTML = '';
        sessionTeams = [];

        // Sort team names naturally (e.g., Team-1, Team-2, Team-10)
        const sortedTeamNames = Object.keys(teamsAndMembers).sort((a, b) =>
          a.localeCompare(b, undefined, {numeric: true, sensitivity: 'base'}),
        );

        // Assuming the order of createdTeamIds matches the sorted team names
        sortedTeamNames.forEach((teamName, index) => {
          const teamId = createdTeamIds[index];
          if (teamId) {
            sessionTeams.push({
              name: teamName,
              id: teamId,
              users: teamsAndMembers[teamName],
            });

            const option = document.createElement('option');
            option.value = teamId;
            option.textContent = `${teamName} (${teamId})`;
            teamSelect.appendChild(option);
          }
        });

        // Add change listener to team dropdown
        teamSelect.addEventListener('change', updateUserDropdown);

        // Trigger the change event to populate the user dropdown for the first team
        teamSelect.dispatchEvent(new Event('change'));
      }

      /**
       * Updates the User ID dropdown when a team is selected.
       */
      function updateUserDropdown() {
        const teamSelect = document.getElementById('teamId');
        const userSelect = document.getElementById('userId');
        const selectedTeamId = teamSelect.value;
        userSelect.innerHTML = '';

        const selectedTeam = sessionTeams.find(t => t.id === selectedTeamId);

        if (selectedTeam && selectedTeam.users.length > 0) {
          selectedTeam.users.forEach(userId => {
            const option = document.createElement('option');
            option.value = userId;
            option.textContent = userId;
            userSelect.appendChild(option);
          });
        } else {
          const option = document.createElement('option');
          option.textContent = '-- No users in team --';
          userSelect.appendChild(option);
        }
      }

      // --- Event Listener for WebSocket Terminal Connection ---
      document.getElementById('connect-btn').addEventListener('click', () => {
        if (ws && ws.readyState !== WebSocket.CLOSED) {
          ws.close();
        }
        term.reset();

        const teamId = document.getElementById('teamId').value;
        const userId = document.getElementById('userId').value;
        const token = document.getElementById('jwt-token').value;

        if (!teamId || !userId || !token) {
          term.write('Please select a Team, a User, and provide a JWT.\r\n');
          return;
        }

        const socketUrl = `ws://${window.location.host}/terminals/${teamId}/${userId}/${token}`;
        term.write(`Connecting to ${socketUrl}...\r\n`);

        ws = new WebSocket(socketUrl);

        ws.onopen = () => {
          term.write('Connection established! You have a shell.\r\n');
          term.focus();
        };

        ws.onmessage = async event => {
          // The data from a WebSocket is often a Blob, which needs to be read
          const data =
            event.data instanceof Blob
              ? new Uint8Array(await event.data.arrayBuffer())
              : event.data;
          term.write(data);
        };

        ws.onclose = event => {
          term.write(`\r\nConnection closed. Code: ${event.code}\r\n`);
        };

        ws.onerror = error => {
          term.write('\r\nAn error occurred with the WebSocket.\r\n');
          console.error('WebSocket Error:', error);
        };
      });

      // --- Set up the single data listener for the terminal ---
      term.onData(data => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(data);
        }
      });
    </script>
  </body>
</html>
